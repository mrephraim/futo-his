<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:insert="fragments :: head(title='PIS Drug Batches - Add New Batch')"></head>
<style>
    .spinner-border {
        vertical-align: middle;
        margin-left: 0.5rem; /* Space between text and loader */
    }
</style>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="mb-5" th:insert="fragments :: headerOne(title='Welcome to PIS Admin Portal')"></div>

            <div class="row align-items-center mb-5 mt-2">
                <h2 class="my-4 text-center">Drug Master Setup</h2>

                <!-- Sample Type Form -->
                <div class="card shadow-sm p-4 mb-4">
                    <h4 class="mb-3">Add Drug</h4>
                    <form id="drugForm">
                        <div class="mb-3">
                            <label class="form-label">Drug Name (Brand Name)</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dosage Form</label>
                            <select class="form-select" name="formId" id="drugFormSelect"></select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="categoryId" id="drugCategorySelect"></select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Generic Name</label>
                            <select class="form-select" name="genericId" id="drugGenericSelect"></select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Active</label>
                            <select class="form-select" name="active">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div id="drugFeedback" class="mt-3"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtnDrug">
                            <span id="buttonTextDrug">Submit</span>
                            <span id="buttonLoaderDrug" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </form>
                </div>

                <div class="card shadow-sm p-4 mb-4">
                    <h4 class="mb-3">Add Drug Package</h4>
                    <form id="drugPackageForm">
                        <div class="mb-3">
                            <label class="form-label">Drug</label>

                            <select class="form-select" name="drugId" id="drugPackageDrugSelect">
                                <option value="">-- Select Drug --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Package Name</label>
                            <input type="text" class="form-control" name="packageName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Sub Package (Optional)</label>
                            <select class="form-select" name="subPackageId" id="drugPackageSubSelect">
                                <option value="">-- None (Base Package) --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Form</label>
                            <select class="form-select" name="formId" id="drugPackageFormSelect"></select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Strength (Only for Base Package)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="strengthValue" step="0.01">
                                <select class="form-select" name="strengthUnitId" id="drugPackageStrengthUnitSelect">
                                    <option value="">-- Unit --</option>
                                </select>
                            </div>
                        </div>

                        <div id="drugPackageFeedback" class="mt-3"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtnDrugPackage">
                            <span id="buttonTextDrugPackage">Submit</span>
                            <span id="buttonLoaderDrugPackage" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </form>
                </div>

                <div class="card shadow-sm p-4 mb-4">
                    <h4 class="mb-3">Add Drug Parameter (Per Base Package)</h4>
                    <form id="drugParamForm">
                        <div class="mb-3">
                            <label class="form-label">Drug</label>
                            <select class="form-select" name="drugId" id="drugParamDrugSelect"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parameter Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Value</label>
                            <input type="text" class="form-control" name="value" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit</label>
                            <select class="form-select" name="unitId" id="drugParamUnitSelect"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description"></textarea>
                        </div>
                        <div id="drugParamFeedback" class="mt-3"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtnDrugParam">
                            <span id="buttonTextDrugParam">Submit</span>
                            <span id="buttonLoaderDrugParam" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </form>
                </div>


            </div>
        </div>
    </div>
</div>



<script>
    async function loadOptions(url, selectId) {
        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success && result.data) {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select...</option>';

                result.data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    select.appendChild(opt);
                });
            } else {
                console.error("Failed:", result.message);
            }
        } catch (e) {
            console.error("Error loading options:", e);
        }
    }

    // Load categories and generics when page loads
    document.addEventListener("DOMContentLoaded", () => {
        loadOptions('/pis/categories', 'drugCategorySelect');
        loadOptions('/pis/generics', 'drugGenericSelect');
    });
</script>


<script>
    // Load dosage forms for dropdown
    async function loadDosageForms() {
      const res = await fetch('/pis/dosage-forms');
      const result = await res.json();

      const select = document.getElementById('drugFormSelect');
      if (result.success && result.data) {
          select.innerHTML = result.data
              .map(f => `<option value="${f.id}">${f.name}</option>`)
              .join('');
      } else {
          select.innerHTML = `<option value="">Failed to load forms</option>`;
      }
  }
  loadDosageForms();

document.getElementById('drugForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtnDrug');
    const txt = document.getElementById('buttonTextDrug');
    const loader = document.getElementById('buttonLoaderDrug');
    txt.classList.add('d-none'); loader.classList.remove('d-none'); btn.disabled = true;

    try {
        const formData = new FormData(this);
        const response = await fetch('/pis/drugs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formData.get('name'),
                formId: parseInt(formData.get('formId')),
                categoryId: parseInt(formData.get('categoryId')),
                genericId: parseInt(formData.get('genericId')),
                description: formData.get('description'),
                active: formData.get('active') === "true"
            })
        });

        const result = await response.json();

        document.getElementById('drugFeedback').innerHTML =
            result.success
                ? `<div class="alert alert-success">${result.message}</div>`
                : `<div class="alert alert-danger">${result.message}</div>`;

        if (result.success) this.reset();
    } catch {
        document.getElementById('drugFeedback').innerHTML =
            `<div class="alert alert-danger">Failed to submit. Try again.</div>`;
    } finally {
        txt.classList.remove('d-none');
        loader.classList.add('d-none');
        btn.disabled = false;
    }
});

</script>
<script>
    async function loadDrugsAndUnits() {
        const resDrugs = await fetch('/pis/drugs');
        const drugs = await resDrugs.json();
        document.getElementById('drugParamDrugSelect').innerHTML =
            drugs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

        const resUnits = await fetch('/pis/units');
        const units = await resUnits.json();
        document.getElementById('drugParamUnitSelect').innerHTML =
            units.map(u => `<option value="${u.id}">${u.name} (${u.category})</option>`).join('');
    }
    loadDrugsAndUnits();

    document.getElementById('drugParamForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtnDrugParam');
        const txt = document.getElementById('buttonTextDrugParam');
        const loader = document.getElementById('buttonLoaderDrugParam');
        txt.classList.add('d-none'); loader.classList.remove('d-none'); btn.disabled = true;

        try {
            const formData = new FormData(this);
            const response = await fetch('/pis/drug-parameters', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drugId: parseInt(formData.get('drugId')),
                    name: formData.get('name'),
                    value: formData.get('value'),
                    unitId: parseInt(formData.get('unitId')),
                    description: formData.get('description')
                })
            });
            const result = await response.json();
            document.getElementById('drugParamFeedback').innerHTML =
                response.ok ? `<div class="alert alert-success">${result.message}</div>`
                            : `<div class="alert alert-danger">${result.message}</div>`;
            if (response.ok) this.reset();
        } catch {
            document.getElementById('drugParamFeedback').innerHTML =
                `<div class="alert alert-danger">Failed to submit. Try again.</div>`;
        } finally { txt.classList.remove('d-none'); loader.classList.add('d-none'); btn.disabled = false; }
    });
</script>
<script>
    async function loadDrugsFormsUnits() {
        // Load drugs
        const resDrugs = await fetch('/pis/drugs');
        const drugs = await resDrugs.json();
        document.getElementById('drugPackageDrugSelect').innerHTML =
        `<option value="">-- Select Drug --</option>` +
        drugs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');


      const res = await fetch('/pis/dosage-forms');
      const forms = await res.json();
      const formSelect = document.getElementById('drugPackageFormSelect');
      formSelect.innerHTML = forms.data
              .map(f => `<option value="${f.id}">${f.name}</option>`)
              .join('');

        // Load units for strength
        const resUnits = await fetch('/pis/units');
        const units = await resUnits.json();
        document.getElementById('drugPackageStrengthUnitSelect').innerHTML =
            `<option value="">-- Unit --</option>` +
            units.map(u => `<option value="${u.id}">${u.name} (${u.category})</option>`).join('');
    }

    document.getElementById('drugPackageDrugSelect').addEventListener('change', async function () {
        const drugId = this.value;
        if (!drugId) return;

        const res = await fetch(`/pis/drugs/${drugId}/packages`);
        const packages = await res.json();
        document.getElementById('drugPackageSubSelect').innerHTML =
            '<option value="">-- Select Package --</option>' +
            packages.map(p => `<option value="${p.id}">${p.packageName} (${p.quantity})</option>`).join('');
    });

    loadDrugsFormsUnits();

    // Submit form
    document.getElementById('drugPackageForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtnDrugPackage');
        const txt = document.getElementById('buttonTextDrugPackage');
        const loader = document.getElementById('buttonLoaderDrugPackage');
        txt.classList.add('d-none'); loader.classList.remove('d-none'); btn.disabled = true;

        try {
            const formData = new FormData(this);
            const body = {
                drugId: parseInt(formData.get('drugId')),
                packageName: formData.get('packageName'),
                quantity: parseInt(formData.get('quantity')),
                subPackageId: formData.get('subPackageId') ? parseInt(formData.get('subPackageId')) : null,
                formId: parseInt(formData.get('formId')),
                strengthValue: formData.get('strengthValue') ? parseFloat(formData.get('strengthValue')) : null,
                strengthUnitId: formData.get('strengthUnitId') ? parseInt(formData.get('strengthUnitId')) : null
            };

            const response = await fetch('/pis/drug-packages', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const result = await response.json();
            document.getElementById('drugPackageFeedback').innerHTML =
                response.ok ? `<div class="alert alert-success">${result.message}</div>`
                            : `<div class="alert alert-danger">${result.message}</div>`;
            if (response.ok) this.reset();
        } catch {
            document.getElementById('drugPackageFeedback').innerHTML =
                `<div class="alert alert-danger">Failed to submit. Try again.</div>`;
        } finally {
            txt.classList.remove('d-none'); loader.classList.add('d-none'); btn.disabled = false;
        }
    });
</script>




<div th:insert="fragments :: footer"></div>
</body>
</html>
